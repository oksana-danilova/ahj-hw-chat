(()=>{"use strict";class e{constructor(e,t){this.container=e,this.activeUser=t}renderConnectionUser(e){const t=document.querySelector(".connection-container"),n=document.createElement("UL"),o=document.createElement("LI"),s=document.createElement("DIV"),a=document.createElement("LI"),c=document.createElement("P");n.classList.add("connection-row"),s.classList.add("connection-prewiew"),c.classList.add("connection-user"),e===this.activeUser?(c.classList.add("you"),c.textContent=`${e} (You)`,window.onbeforeunload=async()=>{const e=`subscriptions/${encodeURIComponent(this.activeUser)}`;console.log(e),fetch(`https://ahj-hw8-1-backend.onrender.com/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}})}):c.textContent=e,t.appendChild(n),n.append(o),o.append(s),n.append(a),a.append(c)}static removeDisconnectionUser(e){const t=Array.from(document.querySelectorAll(".connection-user")).find((t=>t.textContent===e));t&&t.closest(".connection-row").remove()}async renderChat(){const e=document.createElement("DIV"),t=document.createElement("DIV"),n=document.createElement("DIV"),o=document.createElement("FORM"),s=document.createElement("INPUT");t.classList.add("chat-container"),n.classList.add("chat"),o.classList.add("chat-send"),s.classList.add("chat-message"),s.placeholder="Type some text",this.container.appendChild(t),t.append(n),o.append(s),t.append(o),e.classList.add("connection-container"),this.container.appendChild(e),this.messaging();const a=fetch("https://ahj-hw8-1-backend.onrender.com/index/",{method:"GET",headers:{"Content-Type":"application/json"}}),c=await a;if(!c.ok)return void console.error("Ошибка");const r=await c.json();r&&r.forEach((e=>{this.renderConnectionUser(e.nickname)})),this.gettingUsers()}renderMessage(e,t){const n=document.querySelector(".chat"),o=document.createElement("DIV"),s=document.createElement("SPAN"),a=document.createElement("P");o.classList.add("message-container"),s.classList.add("message-information"),a.classList.add("message-text");const c=function(){const e=new Date;let t=e.getHours(),n=e.getMinutes(),o=e.getDate(),s=e.getMonth()+1;return t<10&&(t=`0${t}`),n<10&&(n=`0${n}`),o<10&&(o=`0${o}`),s<10&&(s=`0${s}`),`${t}:${n} ${o}.${s}.${e.getFullYear()}`}();e===this.activeUser?(o.classList.add("right-align"),s.classList.add("you-message"),s.textContent=`${e} (You), ${c}`,a.textContent=t):(s.textContent=`${e}, ${c}`,a.textContent=t),n.appendChild(o),o.append(s),o.append(a)}gettingUsers(){const t=new EventSource("https://ahj-hw8-1-backend.onrender.com/sse");t.addEventListener("open",(e=>{console.log(e),console.log("sse open")})),t.addEventListener("error",(e=>{console.log(e),console.log("sse error")})),t.addEventListener("message",(t=>{console.log(t);const{nickname:n,req:o}=JSON.parse(t.data);"add"===o&&this.renderConnectionUser(n),"remove"===o&&e.removeDisconnectionUser(n),console.log("sse message")}))}messaging(){const e=new WebSocket("wss://ahj-hw8-1-backend.onrender.com/ws"),t=document.querySelector(".chat-message");document.querySelector(".chat-send").addEventListener("submit",(n=>{n.preventDefault();const o={};o.autor=this.activeUser,o.text=t.value,o&&(e.send(JSON.stringify(o)),t.value="")})),e.addEventListener("open",(e=>{console.log(e),console.log("ws open")})),e.addEventListener("close",(e=>{console.log(e),console.log("ws close")})),e.addEventListener("error",(e=>{console.log(e),console.log("ws error")})),e.addEventListener("message",(e=>{const t=JSON.parse(e.data),{chat:n}=t;n.forEach((e=>{const{autor:t}=JSON.parse(e),{text:n}=JSON.parse(e);this.renderMessage(t,n)})),console.log("ws message")}))}}class t{constructor(){this._tooltips=[]}showTooltip(e,t){const n=document.createElement("DIV");n.classList.add("form-error"),n.textContent=e;const o=performance.now();this._tooltips.push({id:o,element:n}),document.body.appendChild(n);const{right:s,top:a}=t.getBoundingClientRect();return n.style.left=`${s+5}px`,n.style.top=a+t.offsetHeight/2-n.offsetHeight/2+"px",o}removeTooltip(e){const t=this._tooltips.find((t=>t.id===e));t&&t.element.remove(),this._tooltips=this._tooltips.filter((t=>t.id!==e))}removeAllTooltip(){this._tooltips.forEach((e=>e.element.remove())),this._tooltips=[]}}class n{constructor(e){this.container=e,this.tooltipFactory=new t}enterUser(){const t=document.createElement("DIV"),o=document.createElement("H1"),s=document.createElement("FORM"),a=document.createElement("INPUT"),c=document.createElement("BUTTON");t.classList.add("modal-container"),o.classList.add("modal-title"),s.classList.add("modal-form"),a.classList.add("modal-input"),c.classList.add("modal-button"),s.setAttribute("novalidate",!0),a.setAttribute("required",!0),a.name="nickname",a.setCustomValidity(""),o.textContent="Выберите псевдоним",c.textContent="Продолжить",this.container.appendChild(t),t.append(o),s.append(a),s.append(c),t.append(s);let r=[];const i=(e,t)=>{r.push({name:t.name,id:this.tooltipFactory.showTooltip(e,t)})};s.addEventListener("submit",(async o=>{let c,d,l;if(o.preventDefault(),r.forEach((e=>this.tooltipFactory.removeTooltip(e.id))),r=[],c=fetch("https://ahj-hw8-1-backend.onrender.com/index/",{method:"GET",headers:{"Content-Type":"application/json"}}),n.generationLoading(t),d=await c,d.ok)if(l=await d.json(),l&&l.forEach((e=>{e.nickname===a.value?a.setCustomValidity("customError"):a.setCustomValidity("")})),s.checkValidity()){const n=a.value,o=new e(this.container,n);if(c=fetch("https://ahj-hw8-1-backend.onrender.com/subscriptions/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:n})}),d=await c,!d.ok)return void console.error("Ошибка");l=await d.json();const{status:s}=l;"OK"===s&&(t.classList.add("display-none"),o.renderChat())}else{const e=n.getError(a);e&&i(e,a)}else console.error("Ошибка")}));const d=e=>{const t=e.target,o=n.getError(t);if(o)i(o,t);else{const e=r.find((e=>e.name===t.name));e&&this.tooltipFactory.removeTooltip(e.id)}t.removeEventListener("blur",d)};a.addEventListener("focus",(()=>{a.addEventListener("blur",d)}))}static getError(e){const t=document.querySelector(".loadingio-spinner-spinner-ugc4sg2wum");t&&t.remove();const n=Object.keys(ValidityState.prototype).find((t=>e.name?"valid"===t?null:(e.validity[t]&&console.log(t),e.validity[t]):null));return n?{nickname:{valueMissing:'Заполните, пожалуйста, поле "Псевдоним"',customError:"Этот псевдоним занят, придумайте другой"}}[e.name][n]:null}static generationLoading(e){if(!document.querySelector(".loadingio-spinner-spinner-tujwj150y7p")){const t=document.createElement("DIV"),n=document.createElement("DIV");t.classList.add("loadingio-spinner-spinner-tujwj150y7p"),n.classList.add("ldio-ap4vnen1k9u"),e.appendChild(t),t.append(n);for(let e=12;0!==e;e-=1)n.append(document.createElement("DIV"))}}}const o=document.querySelector(".app-container");new n(o).enterUser()})();
//# sourceMappingURL=main.js.map